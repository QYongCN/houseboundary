<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>百度地图</title>
    <style type="text/css">
        html{height:100%}
        body{height:100%;margin:0px;padding:0px}
        #container{height:80%}
    </style>
    <script type="text/javascript" src="http://api.map.baidu.com/api?v=2.0&ak=Gh2qoeuR4Afs82ixrcn7foURdAOi0Gph">
        //v2.0版本的引用方式：src="http://api.map.baidu.com/api?v=2.0&ak=您的密钥"
    </script>
    <script src="https://cdn.staticfile.org/jquery/1.10.2/jquery.min.js"></script>
</head>
<body>
    <div id="container"></div>
    <script type="text/javascript">
        var map = new BMap.Map("container");
        // 创建地图实例
        var point = new BMap.Point(116.404, 39.915);
        // 创建点坐标
        map.centerAndZoom(point, 15);
        // 初始化地图，设置中心点坐标和地图级别
        map.enableScrollWheelZoom();

        var  dw = function () {
            // var circle = new BMap.Circle(point,20000,{fillColor:"blue", strokeWeight: 1 ,fillOpacity: 0.3, strokeOpacity: 0.3});
            // map.addOverlay(circle);
            var pStart = new BMap.Point(116.274625,39.958527);
            var pEnd = new BMap.Point(116.307474,39.988409);
            var bs = new BMap.Bounds(pStart,pEnd); //自己规定范围
            var polygon = new BMap.Polygon([
                new BMap.Point(pStart.lng,pStart.lat),
                new BMap.Point(pEnd.lng,pStart.lat),
                new BMap.Point(pEnd.lng,pEnd.lat),
                new BMap.Point(pStart.lng,pEnd.lat)
            ], {strokeColor:"blue", strokeWeight:6, strokeOpacity:0.2});
            map.addOverlay(polygon);
            var ResultArray = [];
            var local =  new BMap.LocalSearch(
                map,
                {renderOptions: {map: map, autoViewport: true},
                    pageCapacity: 50,
                    // onMarkersSet: function(array){
                    //     console.log(array)
                    // },
                    // onInfoHtmlSet:function (LocalResultPoi) {
                    //     console.log(LocalResultPoi);
                    // },
                    // onResultsHtmlSet:function (element) {
                    //     console.log(element);
                    // },
                    onSearchComplete: function (results) {
                        console.log(results);
                        for (var i = 0; i < results.Ir.length; i++){
                            ResultArray.push(results.Ir[i].uid);
                            // var marker = new BMap.Marker(results.Ir[i].point);
                            // map.addOverlay(marker);
                        }
                        var totalPages = results.getNumPages();
                        var currPage = results.getPageIndex();

                        if (currPage < totalPages-1){
                            local.setMarkersSetCallback(function (pois) {
                                console.log(pois);
                                for (var i = 0; i < pois.length; i++){
                                    map.removeOverlay(pois[i].marker);
                                }
                            });
                            local.gotoPage(currPage + 1);
                        }else {
                            local.setMarkersSetCallback(function (pois) {
                                for (var i = 0; i < pois.length; i++){
                                    map.removeOverlay(pois[i].marker);
                                }
                            });
                            for (var j = 0; j < ResultArray.length; j++){
                                queryuid(ResultArray[j]);
                            };
                        }
                    }
                }
            );
            // console.log(ResultArray);

            // local.searchNearby('住宅区',point,20000);
            local.searchInBounds("地产小区", bs);

        };

        function queryuid(uid){
            $.ajax({
                async: false,
                url: "http://map.baidu.com/?pcevaname=pc4.1&qt=ext&ext_ver=new&l=12&uid="+uid,
                dataType: 'jsonp',
                jsonp: 'callback',
                success: function (result) {
                    // console.log(result);
                    var content = result.content;
                    if (null != content.geo && content.geo != undefined){
                        var geo = content.geo;
                        var points = coordinateToPoints(geo);
                        if (points && points.indexOf(";") >= 0){
                            points = points.split(";");
                        };
                        // console.log(points);
                        var arr = [];
                        for(var i = 0; i < points.length-1; i++){
                            var tem = points[i].split(",");
                            arr.push(new BMap.Point(parseFloat(tem[0]), parseFloat(tem[1])));
                        };
                        // console.log(arr);
                        var polygon = new BMap.Polygon(arr, {strokeColor:"red", strokeWeight:2, strokeOpacity:0.5});
                        map.addOverlay(polygon);
                    }
                }
            })
        };

        //坐标转换
        function coordinateToPoints(coordinate) {
            var points ="";
            if (coordinate) {
                var projection = BMAP_NORMAL_MAP.getProjection();

                if (coordinate && coordinate.indexOf("-") >= 0) {
                    coordinate = coordinate.split('-');
                }
                //取点集合
                var tempco = coordinate[1];
                if (tempco && tempco.indexOf(",") >= 0) {
                    tempco = tempco.replace(";","").split(",");
                }
                //分割点，两个一组，组成百度米制坐标
                var temppoints=[];
                for(var i = 0, len = tempco.length; i < len; i++){
                    var obj = new Object();
                    obj.lng=tempco[i];
                    obj.lat=tempco[i+1];
                    temppoints.push(obj);
                    i++;
                }
                //遍历米制坐标，转换为经纬度
                for ( var i = 0, len = temppoints.length; i < len; i++) {
                    //var pos = coordinate[i].split(',');
                    var pos = temppoints[i];
                    var point = projection.pointToLngLat(new BMap.Pixel(pos.lng, pos.lat));
                    points += ([ point.lng, point.lat ].toString() + ";");
                }
            }
            return points;
        };

        dw();
    </script>
</body>
</html>